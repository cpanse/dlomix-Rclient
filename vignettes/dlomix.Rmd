---
title: "On Using the DLOmix service from R"
author:
- name: Christian Panse
  affiliation:
    - &id Functional Genomics Center Zurich - Functional Genomics Center Zurich (FGCZ) - University of Zurich | ETH Zurich, Winterthurerstrasse 190, CH-8057 Zurich, Switzerland
    - Swiss Institute of Bioinformatics (SIB), Quartier Sorge - Batiment Amphipole, CH-1015 Lausanne, Switzerland
  email: cp@fgcz.ethz.ch
package: dlomix
abstract: |
  This vignette provides ...
output:
  BiocStyle::html_document:
    toc_float: true
bibliography: dlomix.bib
vignette: >
  %\usepackage[utf8]{inputenc}
  %\VignetteIndexEntry{primer}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
urlcolor: blue
---

```{r style, echo = FALSE, results = 'asis'}
BiocStyle::markdown()
knitr::opts_chunk$set(fig.wide = TRUE, fig.retina = 3, error=FALSE)
```


# Initial

```{r load}
lp <- file.path(Sys.getenv("HOME"),
                "src/v2.34.0dev.clients/lib/libgrpcclient.so")
stopifnot(file.exists(lp))

dyn.load(lp)
library(dlomix)
```

# Hello, `LKEATIQLDELNQK`!


https://www.nature.com/articles/s41592-019-0426-7

```{r hello}
dlomix::prosit2019IntensityEnsemble("LKEATIQLDELNQK",
                                    collisionEnergy = 0.25,
                                    precursorCharge = 2L,
                                    verbose = TRUE,
                                    url = "dlomix.fgcz.uzh.ch:8080")
```


```{r helperFunction}
## define some R helper function ...
.plotPrositIntensity <- function(peptide,
                                 precursorCharge = 3,
                                 collisionEnergy = 0.35,
                                 ...){
  p <- dlomix::prosit2019IntensityEnsemble(peptide,
      precursorCharge = precursorCharge,
      collisionEnergy = collisionEnergy)

  n <- nchar(peptide)
  
  yIons <- protViz::fragmentIon(peptide)[[1]]$y[seq(1, n-1)]
  bIons <- protViz::fragmentIon(peptide)[[1]]$b[seq(1, n-1)]
  names(yIons) <- paste0('y', seq(1, n-1), "(1+)")
  names(bIons) <- paste0('b', seq(1, n-1), "(1+)")

  ## retrieve mZ and intensities 
  intensity <- p[seq(1, 6 * n)]
  mZ <- p[175 + seq(1, 6 * n)]
  
  idx <- order(mZ)
  mZ <- mZ[idx]
  intensity <- intensity[idx]
  
  ## determine b- and y-ion match
  yIdx <- protViz::findNN(yIons, mZ)
  yHit <- abs(mZ[yIdx] - yIons) < 0.1
  
  bIdx <- protViz::findNN(bIons, mZ)
  bHit <- abs(mZ[bIdx] - bIons) < 0.1
  
  plot(intensity ~ mZ, type = 'h', ...)
  
  points(mZ[yIdx[yHit]], intensity[yIdx[yHit]],
         col = 'red', type = 'h', lwd = 2.0)
  
  points(mZ[bIdx[yHit]], intensity[bIdx[bHit]],
         col = 'cornflowerblue', type = 'h', lwd = 2.0)
  
  axis(4)
  axis(3, mZ[yIdx[yHit]],  names(yHit[yHit]))
  axis(2)
  axis(1, mZ[bIdx[bHit]],  names(bHit[bHit]))

} 
```


```{r LKEATIQLDELNQK, fig.retina=3, fig.height=6, fig.width=8, fig.cap="LKEATIQLDELNQK Prosit predicted MS2; reproduce Fig.1d [@prosit2019] https://www.nature.com/articles/s41592-019-0426-7"}
.plotPrositIntensity("LKEATIQLDELNQK",
                     xlim = c(150, 1000),
                     ylim=c(0,1), axes=FALSE)
```

```{r Fig1, echo=FALSE, out.width="100%", eval=TRUE, fig.cap="Screenshot of Fig.1d [@prosit2019] https://www.nature.com/articles/s41592-019-0426-7"}
  knitr::include_graphics("PrositFig1d.jpg")
```


# Compare Intensity Predictions

Now we use `r BiocStyle::Biocpkg('tartar')` raw file as used in [@rawrr].

```{r Ms2GenericEnsemble}
rawfile <- "/home/cp/.cache/R/ExperimentHub/151e026f793b5c_4590.raw"
i <- c(9594, 12677, 16136, 17193, 11113, 12788, 13204,
       11884, 13868, 14551, 17612)
S <- rawrr::readSpectrum(rawfile = rawfile, scan = i)

iRTpeptides <- c("LGGNEQVTR", "YILAGVENSK", "GTFIIDPGGVIR", "GTFIIDPAAVIR",
                 "GAGSSEPVTGLDAK", "TPVISGGPYEYR", "VEATFGVDESNAK",
                 "TPVITGAPYEYR", "DGLDAASYYAPVR", "ADVTPADFSEWSK",
                 "LFLQFGAQGSPFLK")

sapply(c(1:11), function(idx){
  massError <- (abs(((protViz::parentIonMass(iRTpeptides[idx]) + 1.007)/ 2) - S[[idx]]$pepmass))
  
  HCDEnergy <- S[[idx]]$`HCD Energy eV:` |> as.numeric()
  
  .plotPrositIntensity(iRTpeptides[idx],
                       xlim = c(150, 1000),
                       ylim=c(-1, 1),
                       sub = paste0(iRTpeptides[idx], " | HCD Energy eV:", HCDEnergy),
                       axes = FALSE,
                       collisionEnergy = HCDEnergy / 100,
                       precursorCharge = 2
  )
  
  points(S[[idx]]$mZ, -S[[idx]]$intensity / max(S[[idx]]$intensity), type = 'h')
  massError
})
```


## Compare iRT Predictions

```{r iRTGenericEnsemble, fig.retina=3, fig.width=8, fig.height=8}
## compose data frame
rtdf <- data.frame(row.names = iRTpeptides,
                   Prosit = sapply(iRTpeptides, dlomix::prosit2019IrtEnsemble),
                   SSRC = protViz::ssrc(iRTpeptides),
                   iRT = sapply(iRTpeptides, function(x){protViz::iRTpeptides$rt[which(x == protViz::iRTpeptides$peptide)]}),
                   raw = sapply(S, function(x) x$rtinseconds)
)

.upper <- function(x, y){
  points(x, y, pch=16, col="#1155FF", cex=1.5)
  fit <- lm(y ~ x)
  abline(fit, col='#FFAAAAAA')
}

.lower <- function(x, y){
  fit <- lm(y ~ x)
  par(usr = c(0, 1, 0, 1))
  
  text(0.5, 0.5, paste0("r.squared=",
  round(summary(fit)$r.squared,3)),
  cex = 1.5)
}
pairs(rtdf, upper.panel = .upper, lower.panel = .lower)
```


# Generate a spec library


as provided by FragPipe

|  column| name                               | example            |
|--------|------------------------------------|--------------------|
|     1  |  PrecursorMz                       |  391.536391        |
|     2  |  ProductMz                         |  147.112805        |
|     3  |  Annotation                        |  y1^1              |
|     4  |  ProteinId                         |  P21333            |
|     5  |  GeneName                          |  FLNA              |
|     6  |  PeptideSequence                   |  DLAEDAPWKK        |
|     7  |  ModifiedPeptideSequence           |  DLAEDAPWKK        |
|     8  |  PrecursorCharge                   |  3                 |
|     9  |  LibraryIntensity                  |  10000.0           |
|    10  |  NormalizedRetentionTime           |  19.587033313296157|
|    11  |  PrecursorIonMobility              |                    |
|    12  |  FragmentType                      |  y                 |
|    13  |  FragmentCharge                    |  1                 |
|    14  |  FragmentSeriesNumber              |  1                 |
|    15  |  FragmentLossType                  |                    |
|    16  |  AverageExperimentalRetentionTime  |  1925.1328204860667|




```{r}
L <- dlomix:::composeProsit2019SpecLibrary(
  peptide = "DLAEDAPWKK",
  precursorCharge = 3,
  collisionEnergy = 0.35)

cnames <- names(L)

names(L) <- paste0("x", seq(1, ncol(L)))
L |>
  knitr::kable(font_size = 7)

knitr::kable(data.frame(name=names(L), full.name=cnames))
```

# FAQ

## Howto encode a modification?
```{r diffMod, fig.height=8}
x <- "GDLLQVM[UNIMOD:35]HEAFEK" |>
  dlomix::prosit2019IntensityEnsemble()
y <- "GDLLQVMHEAFEK" |>
  dlomix::prosit2019IntensityEnsemble()

par(mfrow=c(2,1), mar=c(4,4,1,1))
plot((x-y)[1:174]); plot((x-y)[175:348]) 
```

# Session information {-}

```{r sessioninfo, echo=FALSE}
sessionInfo()
```


# References {-}

